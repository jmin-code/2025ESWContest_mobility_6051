<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kakao Map – 주변 인프라 탐색</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100vh}
    
    /* <<< 수정: 디버그용 UI 요소들 숨기기 --- */
    #diag, #badge {
      display: none;
    }
    /* ------------------------------------ */

    .loc-pulse{
      width:14px;height:14px;border-radius:50%;background:#2979ff;box-shadow:0 0 0 rgba(41,121,255,0.6);
      animation:pulse 2s infinite;border:2px solid #fff
    }
    .loc-pulse.red{background:#ff1744;box-shadow:0 0 0 rgba(255,23,68,0.5)}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(41,121,255,0.5)}70%{box-shadow:0 0 0 16px rgba(41,121,255,0)}100%{box-shadow:0 0 0 0 rgba(41,121,255,0)}}
  </style>
  <script id="kakao-sdk"
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=dc0607361ea2324be6bd1e9dc3f262fe&autoload=false&libraries=services"
    defer></script>
</head>
<body>
  <div id="map"></div>
  <div id="diag"></div>
  <div id="badge"></div>

  <script>
    // ===== 진단/유틸 =====
    // <<< 수정: 함수 내용은 비워두어 로그가 출력되지 않도록 함
    function logDiag(msg, isError=false){ /* 비활성화 */ }
    function setBadge(text){ /* 비활성화 */ }

    function getQueryParams() {
      let q = window.location.search;
      if (!q && window.location.hash && window.location.hash.includes('?')) {
        q = window.location.hash.substring(window.location.hash.indexOf('?'));
      }
      return new URLSearchParams(q);
    }
    const qs = getQueryParams();
    function fnum(v){ const x = parseFloat(v); return Number.isFinite(x) ? x : NaN; }

    // ===== 전역 =====
    let map = null;
    let places = null;
    let currentOverlay = null;
    let poiMarkers = [];
    let lastKeyword = '';
    let lastRadius = 2000;
    const FALLBACK = { lat:37.5665, lng:126.9780 };

    // ===== 마커/오버레이 관리 =====
    function setCurrentOverlay(lat, lng, danger=false){
      if (!map) return;
      const pos = new kakao.maps.LatLng(lat, lng);
      if (currentOverlay) currentOverlay.setMap(null);
      currentOverlay = new kakao.maps.CustomOverlay({
        position: pos, content:`<div class="loc-pulse ${danger?'red':''}"></div>`,
        yAnchor:0.5, xAnchor:0.5, zIndex:1000
      });
      currentOverlay.setMap(map);
    }
    function clearPoiMarkers(){ poiMarkers.forEach(m => m.setMap(null)); poiMarkers = []; }

    // ===== 외부에서 주입 가능 API =====
    window.updateCurrentLocation = function(lat, lng){
      if (!map) return;
      const center = new kakao.maps.LatLng(lat, lng);
      map.setCenter(center);
      setCurrentOverlay(lat, lng);
      if (lastKeyword) runNearbySearch(lastKeyword, lat, lng, lastRadius);
    };
    window.setStartLocation = function(lat, lng){
      if (typeof window.updateCurrentLocation === 'function') {
        window.updateCurrentLocation(lat, lng);
      }
    };
    window.setSearchKeyword = function(keyword){
      lastKeyword = (keyword || '').trim();
    };

    // ===== 검색 =====
    function runNearbySearch(keyword, lat, lng, radius=2000){
      if (!places) places = new kakao.maps.services.Places();
      lastKeyword = (keyword || '').trim();
      lastRadius = Number(radius) || 2000;

      if (!lastKeyword) return;

      const center = new kakao.maps.LatLng(lat, lng);
      clearPoiMarkers();
      const bounds = new kakao.maps.LatLngBounds();
      bounds.extend(center);

      places.keywordSearch(
        lastKeyword,
        (data, status) => {
          if (status === kakao.maps.services.Status.OK && data.length){
            data.forEach(place => {
              const y = parseFloat(place.y), x = parseFloat(place.x);
              if (!Number.isFinite(y) || !Number.isFinite(x)) return;
              const pos = new kakao.maps.LatLng(y, x);
              const mk = new kakao.maps.Marker({ map, position: pos, title: place.place_name });
              poiMarkers.push(mk);
              bounds.extend(pos);
            });
            map.setBounds(bounds);
          } else {
            map.setCenter(center);
          }
        },
        { location: center, radius: lastRadius }
      );
    }

    // ===== 초기화 공통 =====
    function readyAt(lat, lng, accuracy=null){
      const center = new kakao.maps.LatLng(lat, lng);
      map.setCenter(center);
      setCurrentOverlay(lat, lng);
      const kw = (qs.get('keyword') || '').trim();
      const radius = parseInt(qs.get('radius') || '2000', 10);
      lastKeyword = kw; lastRadius = Number(radius) || 2000;
      if (kw) runNearbySearch(kw, lat, lng, radius);
    }

    // ===== SDK 로드 후 실행 =====
    function initAfterSdk(){
      map = new kakao.maps.Map(
        document.getElementById('map'),
        { center: new kakao.maps.LatLng(FALLBACK.lat, FALLBACK.lng), level:5 }
      );
      
      const latRaw = qs.get('lat') ?? qs.get('latitude') ?? qs.get('sLat');
      const lngRaw = qs.get('lng') ?? qs.get('lon') ?? qs.get('longitude') ?? qs.get('sLng');
      const latP = fnum(latRaw);
      const lngP = fnum(lngRaw);

      if (Number.isFinite(latP) && Number.isFinite(lngP)){
        readyAt(latP, lngP, null);
        return;
      }

      if ('geolocation' in navigator){
        navigator.geolocation.getCurrentPosition(
          pos => {
            readyAt(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
          },
          err => {
            readyAt(FALLBACK.lat, FALLBACK.lng, null);
          },
          { enableHighAccuracy:true, timeout:6000, maximumAge:0 }
        );
      } else {
        readyAt(FALLBACK.lat, FALLBACK.lng, null);
      }
    }

    function panToLocation(lat, lng) {
        if (!map) return;
        const pos = new kakao.maps.LatLng(lat, lng);
        map.panTo(pos);
    }
    // ===== 부트스트랩 =====
    window.addEventListener('load', () => {
      const sdk = document.getElementById('kakao-sdk');
      sdk.onerror = () => console.error('Kakao SDK 로드 실패! appkey/네트워크 확인.');
      if (!window.kakao || !window.kakao.maps){ return; }
      kakao.maps.load(initAfterSdk);
    });
  </script>
</body>
</html>