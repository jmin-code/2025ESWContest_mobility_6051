<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Kakao Map – 주변 인프라 탐색</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100vh}
    #diag{
      position:fixed;left:12px;bottom:12px;background:rgba(255,255,255,0.92);
      border:1px solid #aaa;border-radius:10px;padding:10px 12px;font:13px/1.5 monospace;
      max-width:560px;max-height:220px;overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,0.08);white-space:pre-wrap
    }
    /* 현재 위치 펄스 표시 (커스텀 오버레이용) */
    .loc-pulse{
      width:14px;height:14px;border-radius:50%;background:#2979ff;box-shadow:0 0 0 rgba(41,121,255,0.6);
      animation: pulse 2s infinite; border:2px solid #fff
    }
    .loc-pulse.red{background:#ff1744;box-shadow:0 0 0 rgba(255,23,68,0.5)}
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(41,121,255,0.5)}
      70%{box-shadow:0 0 0 16px rgba(41,121,255,0)}
      100%{box-shadow:0 0 0 0 rgba(41,121,255,0)}
    }
  </style>
  <script id="kakao-sdk"
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=dc0607361ea2324be6bd1e9dc3f262fe&autoload=false&libraries=services"
    defer></script>
</head>
<body>
  <div id="map"></div>
  <div id="diag">진단 로그:</div>

  <script>
    // ---------- 진단 로그 ----------
    const logBox = () => document.getElementById('diag');
    function logDiag(msg, isError=false){
      const time = new Date().toLocaleTimeString();
      const icon = isError ? '❌' : '✅';
      logBox().textContent += `\n${icon} ${time}: ${msg}`;
      logBox().scrollTop = logBox().scrollHeight;
      (isError ? console.error : console.log)(msg);
    }
    const sdk = document.getElementById('kakao-sdk');
    sdk.onerror = () => logDiag('Kakao SDK 로드 실패! appkey/네트워크 확인.', true);

    // ---------- 전역 상태 ----------
    let map = null;
    let places = null;
    let currentOverlay = null;
    let poiMarkers = [];
    let lastKeyword = '';
    let lastRadius = 2000;

    // ---------- 유틸 ----------
    const qs = new URLSearchParams(location.search);
    const fallbackCenter = {lat:37.5665, lng:126.9780}; // 서울시청

    function parseFloatOrNaN(v){ const x = parseFloat(v); return Number.isFinite(x) ? x : NaN; }
    function clearPoiMarkers(){
      poiMarkers.forEach(m => m.setMap(null));
      poiMarkers = [];
    }
    function setCurrentOverlay(lat, lng, danger=false){
      if (!map) return;
      const pos = new kakao.maps.LatLng(lat, lng);
      if (currentOverlay) currentOverlay.setMap(null);
      currentOverlay = new kakao.maps.CustomOverlay({
        position: pos,
        content: `<div class="loc-pulse ${danger?'red':''}"></div>`,
        yAnchor: 0.5, xAnchor: 0.5, zIndex: 1000
      });
      currentOverlay.setMap(map);
    }

    // 외부(예: PySide6)에서 호출 가능: 현재 좌표 갱신 + 재검색
    window.updateCurrentLocation = function(lat, lng){
      if (!map) { logDiag('map 미초기화 상태에서 updateCurrentLocation 호출됨', true); return; }
      const center = new kakao.maps.LatLng(lat, lng);
      map.setCenter(center);
      setCurrentOverlay(lat, lng);
      if (lastKeyword) runNearbySearch(lastKeyword, lat, lng, lastRadius);
    };

    window.setSearchKeyword = function(keyword){
      lastKeyword = (keyword || '').trim();
      logDiag(`키워드 변경: "${lastKeyword}"`);
    };

    // ---------- 검색 ----------
    function runNearbySearch(keyword, lat, lng, radius=2000){
      if (!places) places = new kakao.maps.services.Places();
      lastKeyword = (keyword || '').trim();
      lastRadius = Number(radius) || 2000;
      if (!lastKeyword){
        logDiag('키워드가 없어 검색을 생략합니다.');
        return;
      }
      const center = new kakao.maps.LatLng(lat, lng);
      logDiag(`검색 시작: "${lastKeyword}", 반경=${lastRadius}m, 기준=(${lat.toFixed(5)}, ${lng.toFixed(5)})`);

      clearPoiMarkers();
      const bounds = new kakao.maps.LatLngBounds();
      bounds.extend(center);

      places.keywordSearch(
        lastKeyword,
        (data, status) => {
          if (status === kakao.maps.services.Status.OK && data.length){
            data.forEach(place => {
              const y = parseFloat(place.y), x = parseFloat(place.x);
              if (!Number.isFinite(y) || !Number.isFinite(x)) return;
              const pos = new kakao.maps.LatLng(y, x);
              const mk = new kakao.maps.Marker({ map, position: pos, title: place.place_name });
              poiMarkers.push(mk);
              bounds.extend(pos);
            });
            map.setBounds(bounds);
            logDiag(`검색 성공: ${data.length}개 결과`);
          } else if (status === kakao.maps.services.Status.ZERO_RESULT){
            logDiag('검색 결과 없음.');
            // 결과가 없어도 기준점은 보여주자
            map.setCenter(center);
          } else {
            logDiag(`검색 실패 (status=${status})`, true);
          }
        },
        { location: center, radius: lastRadius } // Kakao Places 옵션
      );
    }

    // ---------- 준비 로직 ----------
    function readyAt(lat, lng, accuracy=null){
      const center = new kakao.maps.LatLng(lat, lng);
      map.setCenter(center);
      setCurrentOverlay(lat, lng);
      const kw = (qs.get('keyword') || '').trim();
      const radius = parseInt(qs.get('radius') || '2000', 10);
      runNearbySearch(kw, lat, lng, radius);
      if (accuracy != null) logDiag(`현재 위치 정확도: ±${Math.round(accuracy)}m`);
    }

    function initAfterSdk(){
      logDiag('Kakao Map 초기화 시작');
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(fallbackCenter.lat, fallbackCenter.lng), // 흰 화면 방지용 초기값
        level: 5
      });
      logDiag('지도 객체 생성 완료');

      // URL 파라미터 우선
      const latP = parseFloatOrNaN(qs.get('lat'));
      const lngP = parseFloatOrNaN(qs.get('lng'));
      const kw = (qs.get('keyword') || '').trim();
      const radius = parseInt(qs.get('radius') || '2000', 10);

      if (Number.isFinite(latP) && Number.isFinite(lngP)){
        logDiag(`URL 좌표 사용: (${latP}, ${lngP})`);
        readyAt(latP, lngP, null);
        return;
      }

      // 브라우저 GPS 시도
      if ('geolocation' in navigator){
        logDiag('브라우저 위치 요청...');
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            logDiag('브라우저 위치 획득 성공');
            readyAt(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
          },
          (err) => {
            logDiag(`브라우저 위치 실패: ${err.message} → fallback 사용`, true);
            // fallback에서도 키워드가 있으면 검색은 수행
            readyAt(fallbackCenter.lat, fallbackCenter.lng, null);
          },
          { enableHighAccuracy:true, timeout:6000, maximumAge:0 }
        );
      } else {
        logDiag('Geolocation 미지원 → fallback 사용', true);
        readyAt(fallbackCenter.lat, fallbackCenter.lng, null);
      }

      // 초기 파라미터 기록
      lastKeyword = kw; lastRadius = Number(radius) || 2000;
    }

    // ---------- 부트스트랩 ----------
    window.addEventListener('load', () => {
      if (!window.kakao || !window.kakao.maps){
        logDiag('kakao.maps 객체 없음! SDK 로드 상태를 확인하세요.', true);
        return;
      }
      kakao.maps.load(initAfterSdk);
    });
  </script>
</body>
</html>
